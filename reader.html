<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>小说阅读器</title>
<style>
    body { margin: 0; padding: 0; }
    #readerFrame { width: 100%; height: 100vh; border: none; }
    #nav { 
        position: fixed;
        bottom: 10px;
        right: 10px; 
        z-index: 9999;
    }
    button { padding: 8px 16px; font-size: 16px; }
</style>
</head>
<body>

<iframe id="readerFrame"></iframe>

<!-- 底部导航（上一章 / 下一章） -->
<div id="nav">
    <button id="prevBtn">上一章</button>
    <button id="nextBtn">下一章</button>
</div>

<script>
// =============== 解析 URL 参数 ===============
const params = new URLSearchParams(location.search);
let currentUrl = params.get("url");     // 如 "86723/第6章 劇本圍讀.txt"
let chapterList = [];                   // 所有章节列表
let currentIndex = -1;                  // 当前章节索引

// 初始化 iframe
const iframe = document.getElementById("readerFrame");

// 加载 OPML 列表
fetch("novels.opml")
    .then(res => res.text())
    .then(xmlText => {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "text/xml");

        // 获取所有章节
        chapterList = Array.from(xml.querySelectorAll("outline[type='file']"))
                           .map(x => x.getAttribute("url"));

        // 找出当前章节的索引
        currentIndex = chapterList.indexOf(currentUrl);

        // 加载当前章节
        loadChapter();
    });


// =============== 加载章节内容到 iframe ===============
function loadChapter() {
    if (currentIndex < 0 || currentIndex >= chapterList.length) return;

    currentUrl = chapterList[currentIndex];

    // 设置 iframe src
    iframe.src = currentUrl;

    // 自动下一章（监听 iframe 加载完成）
    iframe.onload = () => {
        // 监听页面滚动到底部
        iframe.contentWindow.onscroll = () => {
            const doc = iframe.contentDocument.documentElement;
            if (doc.scrollTop + doc.clientHeight >= doc.scrollHeight - 5) {
                // 底部 → 自动加载下一章
                nextChapter();
            }
        };
    };

    // 更新浏览器 URL（方便刷新继续）
    history.replaceState(null, "", "reader.html?url=" + encodeURIComponent(currentUrl));
}


// =============== 上一章 / 下一章 按钮 ===============
document.getElementById("prevBtn").onclick = () => {
    if (currentIndex > 0) {
        currentIndex--;
        loadChapter();
    }
};

document.getElementById("nextBtn").onclick = () => {
    nextChapter();
};

function nextChapter() {
    if (currentIndex < chapterList.length - 1) {
        currentIndex++;
        loadChapter();
    }
}

</script>

</body>
</html>
