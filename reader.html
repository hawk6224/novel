<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>小说阅读器</title>
<style>
    body { margin: 16px; font-size: 20px; line-height: 1.7; }
    #content { white-space: pre-wrap; }
    #title { font-size: 24px; font-weight: bold; margin-bottom: 20px; }
    #nav {
        position: fixed;
        bottom: 10px;
        right: 10px;
        z-index: 9999;
    }
    button { padding: 8px 16px; font-size: 16px; }
</style>
</head>
<body>

<div id="title"></div>
<div id="content">正在加载章节内容...</div>

<div id="nav">
    <button id="prevBtn">上一章</button>
    <button id="nextBtn">下一章</button>
</div>

<script>
const params = new URLSearchParams(location.search);
let currentUrl = params.get("url");   // 原始章节 URL（中文、空格等）
let chapterList = [];
let chapterTitles = [];
let currentIndex = -1;

// =============== 读取 OPML ===============
fetch("novels.opml")
    .then(r => r.text())
    .then(xmlText => {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlText, "text/xml");

        const outlines = xml.querySelectorAll("outline[type='file']");
        outlines.forEach(x => {
            const url = x.getAttribute("url");
            const title = x.getAttribute("text");
            chapterList.push(url);
            chapterTitles.push(title);
        });

        currentIndex = chapterList.indexOf(decodeURIComponent(currentUrl));

        if (currentIndex < 0) {
            alert("找不到章节：" + currentUrl);
            return;
        }

        loadChapter();
    });


// =============== 加载章节内容（可被朗读工具读取） ===============
function loadChapter() {
    const decodedUrl = decodeURIComponent(chapterList[currentIndex]);

    // 修复中文 URL：要使用 encodeURI，而不是 encodeURIComponent（避免把 / 编码）
    const safeUrl = encodeURI(decodedUrl);

    document.getElementById("title").innerText = chapterTitles[currentIndex];
    document.getElementById("content").innerText = "加载中…";

    fetch(safeUrl)
        .then(r => r.text())
        .then(text => {
            document.getElementById("content").innerText = text;

            history.replaceState(null, "", "reader.html?url=" + encodeURIComponent(chapterList[currentIndex]));

            // 自动下一章：监听滚动
            window.onscroll = () => {
                const bottom = document.documentElement.scrollTop + window.innerHeight;
                if (bottom >= document.documentElement.scrollHeight - 10) {
                    nextChapter();
                }
            };
        })
        .catch(err => {
            document.getElementById("content").innerText = "读取失败：" + safeUrl;
        });
}


// =============== 上一章 / 下一章按钮 ===============
document.getElementById("prevBtn").onclick = () => {
    if (currentIndex > 0) {
        currentIndex--;
        loadChapter();
    }
};

document.getElementById("nextBtn").onclick = () => {
    nextChapter();
};

function nextChapter() {
    if (currentIndex < chapterList.length - 1) {
        currentIndex++;
        loadChapter();
    }
}
</script>

</body>
</html>
